<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlation Analyzer | Trade Intelligence</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f111a;
            --surface-color: rgba(23, 27, 44, 0.7);
            --accent-primary: #00f2ff;
            --accent-secondary: #7000ff;
            --accent-success: #00ff88;
            --accent-danger: #ff0055;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, rgba(0, 242, 255, 0.05) 0, transparent 50%),
                radial-gradient(at 100% 0%, rgba(112, 0, 255, 0.05) 0, transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        h1,
        h2,
        h3 {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-left: 10px;
            padding-right: 10px;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface-color);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        .logo-group h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            /* Allow wrapping on smaller screens */
        }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        /* --- Grid Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: var(--surface-color);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title svg {
            color: var(--accent-primary);
        }

        /* --- Correlation Matrix --- */
        .matrix-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        table.matrix {
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            font-size: 0.85rem;
        }

        .matrix th {
            padding: 15px;
            text-align: center;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 700;
            background: rgba(15, 17, 26, 0.8);
            white-space: nowrap;
        }

        .matrix td {
            text-align: center;
            padding: 18px;
            font-weight: 800;
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 6px;
            transition: transform 0.2s ease;
        }

        .matrix td:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            cursor: help;
        }

        .matrix .row-label {
            text-align: left;
            background: rgba(15, 17, 26, 0.8);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 700;
            padding: 15px;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        /* --- File List --- */
        .file-list {
            list-style: none;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out backwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            color: var(--accent-danger);
            background: rgba(255, 0, 85, 0.1);
        }

        /* --- Charts --- */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .chart-wrapper {
            height: 350px;
            width: 100%;
        }

        /* --- Empty State --- */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            max-width: 300px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* --- Toggle Switch --- */
        .toggle-group {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .toggle-btn {
            padding: 6px 16px;
            border-radius: 8px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* --- Hide default file input --- */
        #fileInput {
            display: none;
        }

        /* --- Professional Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 800;
            font-family: 'Outfit', sans-serif;
        }

        .professional-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-group">
                <h1>Trading Strategy Correlation Analyzer</h1>
                <p style="font-size: 0.8rem; color: var(--text-secondary);">Multi-file diversification intelligence</p>
            </div>
            <div class="controls">
                <div class="toggle-group">
                    <button class="toggle-btn active" onclick="setMode('entry')" id="modeEntry">Entry Date</button>
                    <button class="toggle-btn" onclick="setMode('exit')" id="modeExit">Exit Date</button>
                </div>
                <label for="csvUpload" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Upload CSV Files
                </label>
                <input type="file" id="csvUpload" accept=".csv" multiple style="display: none;"
                    onchange="handleFileUpload(event)">

                <!-- Benchmark Upload -->
                <label for="benchmarkUpload" class="btn"
                    style="background: rgba(112, 0, 255, 0.2); border-color: var(--accent-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Upload Benchmark
                </label>
                <input type="file" id="benchmarkUpload" accept=".csv" style="display: none;"
                    onchange="handleBenchmarkUpload(event)">
                <button class="btn" onclick="showManualModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    Manual Add
                </button>
                <button class="btn" onclick="clearAll()">Clear All</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Left: Matrix & Chart -->
            <div class="main-content" style="display: flex; flex-direction: column; gap: 20px;">
                <div class="panel" id="matrixPanel">
                    <div class="panel-header">
                        <h2 class="section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Correlation Heatmap
                        </h2>
                    </div>
                    <div id="matrixContent">
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Upload at least two CSV files to generate the correlation matrix.</p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2 class="section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            Cumulative Equity Curves
                        </h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right: Files & Info -->
            <div class="sidebar" style="display: flex; flex-direction: column; gap: 20px;">
                <div class="panel" style="flex: 1;">
                    <div class="panel-header">
                        <h2 class="section-title">Active Strategies</h2>
                        <span id="fileCount"
                            style="font-size: 0.8rem; background: var(--accent-primary); color: black; padding: 2px 8px; border-radius: 20px; font-weight: 800;">0</span>
                    </div>
                    <ul class="file-list" id="fileList">
                        <!-- File items go here -->
                    </ul>
                </div>

                <div class="panel">
                    <h2 class="section-title" style="margin-bottom: 15px;">Insights</h2>
                    <div id="insightsPanel" style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                        <p>Upload data to see diversification analysis.</p>
                    </div>
                </div>
            </div>
            <div id="professionalSection"
                style="display: none; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 30px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <h2 style="font-size: 1.5rem;">Professional Analytics</h2>
                    <span
                        style="background: var(--accent-secondary); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;">Unlocked</span>
                </div>

                <div class="stats-grid">
                    <div class="metric-card">
                        <div class="metric-label">Portfolio Sharpe Ratio</div>
                        <div class="metric-value" id="portfolioSharpe">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Diversification Benefit</div>
                        <div class="metric-value" id="diversificationBenefit" style="color: var(--accent-success);">--
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Portfolio Max DD</div>
                        <div class="metric-value" id="portfolioMaxDD" style="color: var(--accent-danger);">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Strategy Corr</div>
                        <div class="metric-value" id="avgCorr">--</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <!-- existing cards -->
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <div class="panel-header">
                        <h2 class="section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Professional Capital Allocation (Optimal Multipliers)
                        </h2>
                    </div>
                    <div id="multiplierTableContent">
                        <!-- Dynamic Table -->
                    </div>
                </div>

                <div class="professional-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="section-title">Drawdown Synchronization</h2>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="drawdownChart"></canvas>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="section-title">Rolling Correlation (30D)</h2>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="rollingCorrChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- --- Manual Add Modal --- -->
        <div id="manualModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; justify-content: center; align-items: center;">
            <div class="panel"
                style="width: 500px; max-width: 90vw; border-color: var(--accent-primary); box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
                <div class="panel-header">
                    <h2 class="section-title">Manual Strategy Input</h2>
                    <button class="action-btn" onclick="closeManualModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label
                            style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Strategy
                            Name</label>
                        <input type="text" id="manualName" placeholder="e.g. My Custom Strategy"
                            style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; padding: 10px; border-radius: 8px; font-family: inherit;">
                    </div>
                    <div>
                        <label
                            style="display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">P&L
                            Data (Format: Date, PNL or just PNL list)</label>
                        <textarea id="manualData" placeholder="2023-01-01, 1500&#10;2023-01-02, -500&#10;..."
                            style="width: 100%; height: 200px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; padding: 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; resize: none;"></textarea>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4;">
                        <b>Tip:</b> You can paste a single column of daily P&L values, or two columns (Date, P&L).
                    </div>
                    <button class="btn btn-primary" onclick="saveManualStrategy()"
                        style="width: 100%; justify-content: center; padding: 12px;">Add Strategy</button>
                </div>
            </div>
        </div>

        <script>
            // --- State Management ---
            let strategies = []; // { name, trades: [], dailyPnl: {}, color }
            let benchmarkData = null; // { dateString: percentChange }
            let currentMode = 'entry'; // 'entry' or 'exit'
            let chart = null;
            let drawdownChart = null;
            let rollingCorrChart = null;

            const colors = [
                '#00f2ff', '#7000ff', '#00ff88', '#ff0055', '#ff9900',
                '#0066ff', '#e2e8f0', '#ff00ff', '#14b8a6', '#f97316'
            ];

            // --- Core Math Functions ---
            function calculatePearson(x, y) {
                const n = x.length;
                if (n === 0) return 0;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
                for (let i = 0; i < n; i++) {
                    sumX += x[i]; sumY += y[i];
                    sumXY += x[i] * y[i];
                    sumX2 += x[i] * x[i]; sumY2 += y[i] * y[i];
                }
                const num = n * sumXY - sumX * sumY;
                const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
                return den === 0 ? 0 : num / den;
            }

            function calculateSharpeRatio(dailyPnlValues) {
                const n = dailyPnlValues.length;
                if (n < 2) return 0;
                const avg = dailyPnlValues.reduce((a, b) => a + b, 0) / n;
                const stdDev = Math.sqrt(dailyPnlValues.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b, 0) / (n - 1));
                if (stdDev === 0) return 0;
                return (avg / stdDev) * Math.sqrt(252); // Annualized
            }

            function calculateDrawdowns(dailyPnlValues) {
                let cum = 0;
                let high = 0;
                const drawdowns = [];
                dailyPnlValues.forEach(pnl => {
                    cum += pnl;
                    if (cum > high) high = cum;
                    const dd = high === 0 ? 0 : cum - high;
                    drawdowns.push(dd);
                });
                return drawdowns;
            }

            function calculateRollingCorrelation(seriesA, seriesB, window = 30) {
                const rolling = [];
                for (let i = 0; i < seriesA.length; i++) {
                    if (i < window - 1) {
                        rolling.push(null);
                        continue;
                    }
                    const sliceA = seriesA.slice(i - window + 1, i + 1);
                    const sliceB = seriesB.slice(i - window + 1, i + 1);
                    rolling.push(calculatePearson(sliceA, sliceB));
                }
                return rolling;
            }

            function calculateOptimalMultipliers(strats, allDates) {
                // Logic: Risk Parity / Inverse Volatility weighting
                // Goal: Equalize the risk contribution of each strategy
                const vols = strats.map(s => {
                    const values = allDates.map(d => s.dailyPnl[d] || 0);
                    const n = values.length;
                    if (n < 2) return 1; // Cannot calculate std dev for less than 2 points, assume 1 to avoid division by zero
                    const avg = values.reduce((a, b) => a + b, 0) / n;
                    const variance = values.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b, 0) / (n - 1);
                    return Math.sqrt(variance) || 1; // standard deviation, default to 1 if 0
                });

                const inverseVols = vols.map(v => 1 / v);
                const sumInverse = inverseVols.reduce((a, b) => a + b, 0);

                // Normalize to a base of 1.0 (so an "average" strategy would be 1.0)
                const target = sumInverse / strats.length;
                const multipliers = inverseVols.map(iv => iv / target);

                return multipliers;
            }

            // --- Core Functions ---
            async function handleFileUpload(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                for (const file of files) {
                    // Check if already uploaded
                    if (strategies.some(s => s.name === file.name)) continue;

                    const text = await file.text();
                    const trades = parseCSV(text);

                    if (trades.length > 0) {
                        strategies.push({
                            name: file.name,
                            trades: trades,
                            color: colors[strategies.length % colors.length],
                            multiplier: 1.0
                        });
                    }
                }

                processAndRender();
                event.target.value = ''; // Reset input
            }

            function parseCSV(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
                if (lines.length < 2) return [];

                const header = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/[^a-z0-9\/ %#-]/g, ''));

                // Detection logic
                let dateIdx = -1, pnlIdx = -1, signalIdx = -1, tradeNumIdx = -1;

                header.forEach((h, i) => {
                    const norm = h.replace(/[^a-z0-9]/g, '');
                    if (dateIdx === -1 && h.includes('date')) dateIdx = i;
                    if (signalIdx === -1 && (h.includes('signal') || h.includes('type'))) signalIdx = i;
                    if (tradeNumIdx === -1 && (h.includes('trade #') || h.includes('trade#') || h.includes('id'))) tradeNumIdx = i;
                    const isNetPnl = h.includes('net') && (h.includes('p&l') || h.includes('pnl'));
                    if (isNetPnl) pnlIdx = i;
                    else if (pnlIdx === -1 && (h.includes('p&l') || h.includes('pnl'))) pnlIdx = i;
                });

                if (pnlIdx === -1) pnlIdx = 7;

                const entryCache = {}; // tradeNum -> date
                const trades = [];

                // PASS 1: Cache all Entries
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length <= dateIdx) continue;
                    const rawSignal = signalIdx !== -1 ? cols[signalIdx].toLowerCase() : '';
                    const rawTradeNum = tradeNumIdx !== -1 ? cols[tradeNumIdx].trim() : '';
                    const dateObj = parseRobusteDate(cols[dateIdx]);

                    if (dateObj && (rawSignal.includes('entry') || rawSignal.includes('enter') || rawSignal.includes('open'))) {
                        if (rawTradeNum) entryCache[rawTradeNum] = dateObj;
                    }
                }

                // PASS 2: Process Exits
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length <= Math.max(dateIdx, pnlIdx)) continue;

                    const rawSignal = signalIdx !== -1 ? cols[signalIdx].toLowerCase() : '';
                    const rawTradeNum = tradeNumIdx !== -1 ? cols[tradeNumIdx].trim() : '';
                    const rawPnl = cols[pnlIdx];
                    const dateObj = parseRobusteDate(cols[dateIdx]);

                    if (!dateObj) continue;

                    // Skip Entry rows in this pass
                    if (rawSignal.includes('entry') || rawSignal.includes('enter') || rawSignal.includes('open')) continue;

                    const pnl = parseFloat(rawPnl.replace(/[^0-9.\-]/g, '')) || 0;
                    if (Math.abs(pnl) < 0.01) continue;

                    const entryDate = (rawTradeNum && entryCache[rawTradeNum]) ? entryCache[rawTradeNum] : dateObj;

                    trades.push({
                        entryDate: entryDate,
                        exitDate: dateObj,
                        pnl: pnl
                    });
                }

                // Fallback for one-row-per-trade
                if (trades.length === 0) {
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        const pnl = parseFloat((cols[pnlIdx] || '').replace(/[^0-9.\-]/g, '')) || 0;
                        const dateObj = parseRobusteDate(cols[dateIdx]);
                        if (dateObj && Math.abs(pnl) > 0.01) {
                            trades.push({ entryDate: dateObj, exitDate: dateObj, pnl: pnl });
                        }
                    }
                }
                return trades;
            }

            function parseRobusteDate(str) {
                if (!str) return null;
                // Split by space to get date part only if time is included
                const datePart = str.split(' ')[0].trim();
                let d = new Date(datePart);
                if (!isNaN(d.getTime())) return d;

                // Try manual format DD-MM-YYYY or DD/MM/YYYY
                const parts = datePart.split(/[-/.]/);
                if (parts.length === 3) {
                    let [p1, p2, p3] = parts;
                    if (p1.length === 4) return new Date(p1, p2 - 1, p3); // YYYY-MM-DD
                    return new Date(p3.length === 2 ? '20' + p3 : p3, p2 - 1, p1); // DD-MM-YYYY
                }
                return null;
            }

            function formatDateLocal(d) {
                return d.getFullYear() + '-' + (d.getMonth() + 1).toString().padStart(2, '0') + '-' + d.getDate().toString().padStart(2, '0');
            }

            function processAndRender() {
                // 1. Update Strategy aggregations based on currentMode
                strategies.forEach(s => {
                    s.dailyPnl = {};
                    s.trades.forEach(t => {
                        const dateObj = currentMode === 'exit' ? t.exitDate : t.entryDate;
                        const ds = formatDateLocal(dateObj);
                        s.dailyPnl[ds] = (s.dailyPnl[ds] || 0) + t.pnl;
                    });
                });

                renderFileList();
                renderCorrelationMatrix();
                renderEquityChart();
                renderInsights();
                renderProfessionalAnalytics();

                document.getElementById('fileCount').textContent = strategies.length;
            }

            function setMode(mode) {
                currentMode = mode;
                document.getElementById('modeEntry').classList.toggle('active', mode === 'entry');
                document.getElementById('modeExit').classList.toggle('active', mode === 'exit');
                processAndRender();
            }

            function removeStrategy(name) {
                strategies = strategies.filter(s => s.name !== name);
                processAndRender();
            }

            function clearAll() {
                strategies = [];
                processAndRender();
                if (chart) chart.destroy();
                if (drawdownChart) drawdownChart.destroy();
                if (rollingCorrChart) rollingCorrChart.destroy();
                chart = null;
                drawdownChart = null;
                rollingCorrChart = null;
            }

            // --- Render Helpers ---
            function renderFileList() {
                const list = document.getElementById('fileList');
                list.innerHTML = '';

                strategies.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                    <div class="file-info">
                        <span class="file-name" style="border-left: 3px solid ${s.color}; padding-left: 10px;">${s.name}</span>
                        <span class="file-meta">${s.trades.length} trades</span>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn" onclick="removeStrategy('${s.name}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                    list.appendChild(li);
                });
            }

            function renderCorrelationMatrix() {
                const container = document.getElementById('matrixContent');
                if (strategies.length < 2) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>Upload at least two strategy files to analyze correlation.</p>
                    </div>`;
                    return;
                }

                // Align Dates
                const allDatesSet = new Set();
                strategies.forEach(s => Object.keys(s.dailyPnl).forEach(d => allDatesSet.add(d)));
                const allDates = Array.from(allDatesSet).sort();

                // Prepare Series
                const series = strategies.map(s => allDates.map(d => s.dailyPnl[d] || 0));

                // Compute Correlation
                let html = '<div class="matrix-container"><table class="matrix"><thead><tr><th></th>';
                strategies.forEach(s => html += `<th>${s.name.replace('.csv', '')}</th>`);
                html += '</tr></thead><tbody>';

                for (let i = 0; i < strategies.length; i++) {
                    html += `<tr><td class="row-label">${strategies[i].name.replace('.csv', '')}</td>`;
                    for (let j = 0; j < strategies.length; j++) {
                        const r = calculatePearson(series[i], series[j]);
                        const cellColor = getHeatmapColor(r, i === j);
                        const textColor = (Math.abs(r) > 0.4 && i !== j) ? '#fff' : 'var(--text-secondary)';

                        html += `
                        <td style="background: ${cellColor}; color: ${textColor};" title="Correlation between ${strategies[i].name} and ${strategies[j].name}">
                            ${r.toFixed(2)}
                        </td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            function calculatePearson(x, y) {
                const n = x.length;
                if (n === 0) return 0;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
                for (let i = 0; i < n; i++) {
                    sumX += x[i]; sumY += y[i];
                    sumXY += x[i] * y[i];
                    sumX2 += x[i] * x[i]; sumY2 += y[i] * y[i];
                }
                const num = n * sumXY - sumX * sumY;
                const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
                return den === 0 ? 0 : num / den;
            }

            function getHeatmapColor(r, isDiagonal) {
                if (isDiagonal) return 'rgba(255, 255, 255, 0.05)';

                // Positive: Gradient from Green to Red
                if (r > 0.7) return 'rgba(255, 0, 85, 0.6)'; // Strong positive (Hot)
                if (r > 0.4) return 'rgba(255, 153, 0, 0.4)'; // Moderate positive
                if (r >= 0) return 'rgba(0, 255, 136, 0.1)'; // Neutral to low positive

                // Negative: Blue
                if (r < -0.4) return 'rgba(0, 242, 255, 0.4)'; // Strong diversification
                return 'rgba(0, 242, 255, 0.1)';
            }

            function renderEquityChart() {
                const ctx = document.getElementById('equityChart').getContext('2d');
                if (chart) chart.destroy();

                if (strategies.length === 0) return;

                // Align Dates for Chart
                const allDatesSet = new Set();
                strategies.forEach(s => Object.keys(s.dailyPnl).forEach(d => allDatesSet.add(d)));
                const allDates = Array.from(allDatesSet).sort();

                const datasets = strategies.map(s => {
                    let cum = 0;
                    const data = allDates.map(d => {
                        cum += (s.dailyPnl[d] || 0) * (s.multiplier || 1.0);
                        return cum;
                    });

                    return {
                        label: s.name.replace('.csv', ''),
                        data: data,
                        borderColor: s.color,
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    };
                });

                // Add Combined Portfolio
                if (strategies.length > 1) {
                    let portCum = 0;
                    const portData = allDates.map(d => {
                        let dailyTotal = 0;
                        strategies.forEach(s => dailyTotal += (s.dailyPnl[d] || 0) * (s.multiplier || 1.0));
                        portCum += dailyTotal;
                        return portCum;
                    });

                    datasets.unshift({
                        label: 'COMBINED PORTFOLIO',
                        data: portData,
                        borderColor: '#fff',
                        borderWidth: 4,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: {
                            target: 'origin',
                            above: 'rgba(255, 255, 255, 0.05)'
                        },
                        order: -1
                    });
                }

                chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: allDates, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#fff', boxWidth: 12, font: { size: 10, weight: 'bold' } }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 17, 26, 0.95)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#f8fafc',
                                    font: { size: 12, weight: 'bold' },
                                    maxTicksLimit: 12
                                },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            y: {
                                ticks: {
                                    color: '#f8fafc',
                                    font: { size: 12, weight: 'bold' },
                                    callback: function (value) {
                                        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumSignificantDigits: 3 }).format(value);
                                    }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }

            function renderInsights() {
                const panel = document.getElementById('insightsPanel');
                if (strategies.length < 2) {
                    panel.innerHTML = '<p>Upload more strategies to see diversification metrics.</p>';
                    return;
                }

                // Group dates by strategy combinations
                const combinationGroups = {};
                const allDatesSet = new Set();
                strategies.forEach(s => Object.keys(s.dailyPnl).forEach(d => allDatesSet.add(d)));
                const allDates = Array.from(allDatesSet).sort();

                allDates.forEach(d => {
                    const activeIndices = [];
                    strategies.forEach((s, idx) => { if (s.dailyPnl[d] !== undefined) activeIndices.push(idx); });

                    if (activeIndices.length >= 2) {
                        const key = activeIndices.join(',');
                        if (!combinationGroups[key]) combinationGroups[key] = [];
                        combinationGroups[key].push(d);
                    }
                });

                const coincidentDays = allDates.filter(d => {
                    let activeCount = 0;
                    strategies.forEach(s => { if (s.dailyPnl[d] !== undefined) activeCount++; });
                    return activeCount >= 2;
                }).length;

                const overlapPct = ((coincidentDays / allDates.length) * 100).toFixed(1);

                // Format Coincident Groups Html
                const combinationKeys = Object.keys(combinationGroups).sort((a, b) => b.split(',').length - a.split(',').length);
                const coincidentDatesHtml = combinationKeys.map(key => {
                    const indices = key.split(',').map(Number);
                    const groupStrats = indices.map(idx => strategies[idx]);
                    const stratDisplayNames = groupStrats.map(s => s.name.replace('.csv', '')).join(', ');
                    const dots = groupStrats.map(s => `<span style="background: ${s.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px;"></span>`).join('');

                    const days = combinationGroups[key];
                    const daysHtml = days.map(d => `
                        <div style="font-family: monospace; font-size: 0.7rem; color: #fff; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px;">
                            ${d}
                        </div>`).join('');

                    return `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); margin-bottom: 10px;">
                            <div style="font-size: 0.8rem; font-weight: 800; color: var(--accent-primary); display: flex; align-items: center; gap: 8px;">
                                ${dots} ${stratDisplayNames}
                            </div>
                            <div style="font-size: 0.7rem; font-weight: 800; background: var(--accent-primary); color: #000; padding: 2px 8px; border-radius: 10px;">
                                ${days.length} Days
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px;">
                            ${daysHtml}
                        </div>
                    </div>`;
                }).join('');

                const activeDatesHtml = allDates.map(d => {
                    const activeStrats = strategies.filter(s => s.dailyPnl[d] !== undefined).map(s => `<span style="background: ${s.color}; width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px;"></span>`).join('');
                    const stratNames = strategies.filter(s => s.dailyPnl[d] !== undefined).map(s => s.name.replace('.csv', '')).join(', ');
                    return `
                    <div style="font-family: monospace; font-size: 0.75rem; padding: 6px 8px; background: rgba(255, 255, 255, 0.03); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; gap: 4px;">
                        <div style="font-weight: 700; color: white; display: flex; justify-content: space-between;">
                            ${d}
                            <div>${activeStrats}</div>
                        </div>
                        <div style="font-size: 0.65rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${stratNames}</div>
                    </div>`;
                }).join('');

                panel.innerHTML = `
                <div style="background: rgba(0, 242, 255, 0.05); padding: 15px; border-radius: 12px; border: 1px dashed var(--accent-primary); margin-bottom: 15px;">
                    <div style="font-weight: 800; color: var(--accent-primary); margin-bottom: 10px; font-size: 1.1rem;">Portfolio Timeline</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Active Days:</span>
                        <span style="color: white; font-weight: 700;">${allDates.length} days</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Coincident Days:</span>
                        <span style="color: var(--accent-primary); font-weight: 700;">${coincidentDays} days</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span>Overlap Rank:</span>
                        <span style="color: var(--accent-success); font-weight: 700;">${overlapPct}%</span>
                    </div>

                    <div style="margin-top: 5px;">
                        <div style="display: flex; gap: 10px; padding: 4px; border-radius: 8px;">
                            <button id="btnCoinc" onclick="toggleTimeline('coinc')" style="flex: 1; border: none; background: rgba(255,255,255,0.1); color: var(--accent-primary); font-size: 0.7rem; font-weight: 800; cursor: pointer; text-transform: uppercase; padding: 8px 0; border-radius: 6px; transition: all 0.2s; border: 1px solid rgba(0, 242, 255, 0.3);">Coincident</button>
                            <button id="btnActive" onclick="toggleTimeline('active')" style="flex: 1; border: none; background: rgba(255,255,255,0.03); color: white; font-size: 0.7rem; font-weight: 800; cursor: pointer; text-transform: uppercase; padding: 8px 0; border-radius: 6px; transition: all 0.2s; opacity: 0.6; border: 1px solid var(--border-color);">Active (${allDates.length})</button>
                        </div>
                        
                        <div id="coincDatesList" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; padding-right: 5px; margin-top: 10px;" class="custom-scrollbar">
                            ${coincidentDays > 0 ? coincidentDatesHtml : '<div style="font-size: 0.8rem; opacity: 0.6; text-align: center; padding: 20px;">No overlapping dates.</div>'}
                        </div>
                        <div id="activeDatesList" style="max-height: 200px; overflow-y: auto; display: none; flex-direction: column; gap: 6px; padding-right: 5px; margin-top: 10px;" class="custom-scrollbar">
                            ${activeDatesHtml}
                        </div>
                    </div>
                </div>

                <div style="font-size: 0.8rem; line-height: 1.4;">
                    <p style="margin-bottom: 8px;"><b style="color: var(--accent-primary);">Timeline Logic:</b> Each date shows colored indicators for the strategies active on that day.</p>
                </div>
            `;
            }

            function toggleTimeline(mode) {
                const coincList = document.getElementById('coincDatesList');
                const activeList = document.getElementById('activeDatesList');
                const btnC = document.getElementById('btnCoinc');
                const btnA = document.getElementById('btnActive');

                if (!coincList || !activeList || !btnC || !btnA) return;

                if (mode === 'coinc') {
                    coincList.style.display = 'flex';
                    activeList.style.display = 'none';
                    btnC.style.background = 'rgba(255,255,255,0.1)';
                    btnC.style.color = 'var(--accent-primary)';
                    btnC.style.opacity = '1';
                    btnC.style.borderColor = 'rgba(0, 242, 255, 0.3)';

                    btnA.style.background = 'rgba(255,255,255,0.03)';
                    btnA.style.color = 'white';
                    btnA.style.opacity = '0.6';
                    btnA.style.borderColor = 'var(--border-color)';
                } else {
                    coincList.style.display = 'none';
                    activeList.style.display = 'flex';
                    btnA.style.background = 'rgba(255,255,255,0.1)';
                    btnA.style.color = 'white';
                    btnA.style.opacity = '1';
                    btnA.style.borderColor = 'rgba(255, 255, 255, 0.3)';

                    btnC.style.background = 'rgba(255,255,255,0.03)';
                    btnC.style.color = 'white';
                    btnC.style.opacity = '0.6';
                    btnC.style.borderColor = 'var(--border-color)';
                }
            }

            // --- Professional Analytics Renderers ---
            function renderProfessionalAnalytics() {
                const section = document.getElementById('professionalSection');
                if (strategies.length < 2) {
                    section.style.display = 'none';
                    return;
                }
                section.style.display = 'block';

                // Align Dates
                const allDatesSet = new Set();
                strategies.forEach(s => Object.keys(s.dailyPnl).forEach(d => allDatesSet.add(d)));
                const allDates = Array.from(allDatesSet).sort();

                // 1. Portfolio Daily P&L
                const portfolioDaily = allDates.map(d => {
                    let sum = 0;
                    strategies.forEach(s => sum += (s.dailyPnl[d] || 0) * (s.multiplier || 1.0));
                    return sum;
                });

                // 2. Metrics
                const portSharpe = calculateSharpeRatio(portfolioDaily);
                document.getElementById('portfolioSharpe').textContent = portSharpe.toFixed(2);

                const portDrawdowns = calculateDrawdowns(portfolioDaily);
                const maxDD = Math.min(...portDrawdowns);
                document.getElementById('portfolioMaxDD').textContent = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(maxDD);

                // Diversification Benefit
                const sumIndividualMaxDD = strategies.reduce((acc, s) => {
                    const sPnl = allDates.map(d => s.dailyPnl[d] || 0);
                    const sDD = calculateDrawdowns(sPnl);
                    return acc + Math.min(...sDD);
                }, 0);
                const benefit = sumIndividualMaxDD === 0 ? 0 : (1 - (maxDD / sumIndividualMaxDD)) * 100;
                document.getElementById('diversificationBenefit').textContent = benefit.toFixed(1) + '%';

                // Avg Correlation
                let totalCorr = 0, count = 0;
                for (let i = 0; i < strategies.length; i++) {
                    for (let j = i + 1; j < strategies.length; j++) {
                        const si = allDates.map(d => strategies[i].dailyPnl[d] || 0);
                        const sj = allDates.map(d => strategies[j].dailyPnl[d] || 0);
                        totalCorr += calculatePearson(si, sj);
                        count++;
                    }
                }
                document.getElementById('avgCorr').textContent = (totalCorr / (count || 1)).toFixed(2);

                // 3. Render Multiplier Table
                const multipliers = calculateOptimalMultipliers(strategies, allDates);
                const currentSum = strategies.reduce((a, s) => a + s.multiplier, 0);
                const targetSum = multipliers.reduce((a, m) => a + m, 0);

                let mHtml = `
                    <div class="matrix-container" style="border: none;">
                    <table class="matrix" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Strategy Name</th>
                                <th>Daily Volatility</th>
                                <th>Current Qty</th>
                                <th>Target Qty (Balanced)</th>
                                <th>Target Qty (Rounded)</th>
                                <th>Market Corr (Beta)</th>
                                <th>Professional Advice</th>
                            </tr>
                        </thead>
                        <tbody>`;

                strategies.forEach((s, i) => {
                    // Scaled target to match user's current total portfolio size
                    const targetM = (multipliers[i] / (targetSum || 1)) * (currentSum || 1);
                    const currentM = s.multiplier;
                    const ratio = targetM / (currentM || 0.0001);

                    let advice, adviceColor;
                    if (ratio > 1.1) {
                        advice = 'Under-weighted (Increase)';
                        adviceColor = 'var(--accent-success)';
                    } else if (ratio < 0.9) {
                        advice = 'Over-weighted (Decrease)';
                        adviceColor = 'var(--accent-danger)';
                    } else {
                        advice = 'Perfectly Balanced';
                        adviceColor = 'var(--accent-primary)';
                    }

                    // Market Correlation (Beta)
                    let marketCorr = 'N/A';
                    let marketCorrColor = 'var(--text-secondary)';

                    if (benchmarkData) {
                        // Align Strategy PnL and Benchmark Returns
                        const stratValues = [];
                        const benchValues = [];

                        // We need overlap dates
                        const overlapDates = allDates.filter(d => s.dailyPnl[d] !== undefined && benchmarkData[d] !== undefined);

                        if (overlapDates.length > 10) { // Require some overlap
                            overlapDates.forEach(d => {
                                stratValues.push(s.dailyPnl[d]);
                                benchValues.push(benchmarkData[d]);
                            });

                            const beta = calculatePearson(stratValues, benchValues);
                            marketCorr = beta.toFixed(2);

                            if (beta > 0.6) marketCorrColor = 'var(--accent-danger)'; // High Risk
                            else if (beta < -0.3) marketCorrColor = '#0066ff'; // Hedge
                            else if (beta >= -0.3 && beta <= 0.3) marketCorrColor = 'var(--accent-success)'; // Neutral
                            else marketCorrColor = 'var(--accent-primary)'; // Moderate
                        }
                    }

                    // Calculate vol for display
                    const values = allDates.map(d => s.dailyPnl[d] || 0);
                    const n = values.length;
                    const avg = values.reduce((a, b) => a + b, 0) / n;
                    const vol = Math.sqrt(values.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b, 0) / (n - 1)) || 0;

                    mHtml += `
                        <tr>
                            <td class="row-label" style="border-left: 4px solid ${s.color};">${s.name.replace('.csv', '')}</td>
                            <td style="color: var(--text-secondary);">${vol.toFixed(0)}</td>
                            <td>
                                <input type="number" step="0.05" value="${s.multiplier.toFixed(2)}" 
                                    onchange="updateMultiplier(${i}, this.value)"
                                    style="width: 70px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; padding: 5px; border-radius: 6px; text-align: center; font-weight: 800;">
                                <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 5px;">x</span>
                            </td>
                            <td style="color: #fff; font-size: 1rem;">${targetM.toFixed(2)}x</td>
                            <td style="color: #fff; font-size: 1rem; font-weight: 800; text-align: center;">${Math.round(targetM)}</td>
                            <td style="color: ${marketCorrColor}; font-weight: 700; text-align: center;">${marketCorr}</td>
                            <td style="color: ${adviceColor}; font-weight: 700;">${advice}</td>
                        </tr>`;
                });
                mHtml += '</tbody></table></div>';
                document.getElementById('multiplierTableContent').innerHTML = mHtml;

                // 4. Render Professional Charts
                renderDrawdownChart(allDates, strategies, portDrawdowns);
                renderRollingCorrChart(allDates, strategies);
            }

            function renderDrawdownChart(allDates, strats, portDrawdowns) {
                const ctx = document.getElementById('drawdownChart').getContext('2d');
                if (drawdownChart) drawdownChart.destroy();

                const datasets = strats.map(s => {
                    const sPnl = allDates.map(d => (s.dailyPnl[d] || 0) * (s.multiplier || 1.0));
                    return {
                        label: s.name.replace('.csv', ''),
                        data: calculateDrawdowns(sPnl),
                        borderColor: s.color,
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        opacity: 0.5
                    };
                });

                datasets.unshift({
                    label: 'PORTFOLIO DRAWDOWN',
                    data: portDrawdowns,
                    borderColor: '#fff',
                    borderWidth: 3,
                    pointRadius: 0,
                    fill: { target: 'origin', above: 'rgba(255, 0, 85, 0.2)' },
                    order: -1
                });

                drawdownChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: allDates, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#fff', font: { size: 10, weight: 'bold' } }
                            }
                        },
                        scales: {
                            x: { ticks: { color: 'rgba(255,255,255,0.3)', maxTicksLimit: 8 }, grid: { display: false } },
                            y: { ticks: { color: 'rgba(255,255,255,0.3)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }

            function renderRollingCorrChart(allDates, strats) {
                const ctx = document.getElementById('rollingCorrChart').getContext('2d');
                if (rollingCorrChart) rollingCorrChart.destroy();

                const datasets = [];
                if (strats.length >= 2) {
                    // Calculate Average Rolling Correlation of all unique pairs
                    const numDays = allDates.length;
                    const avgRolling = new Array(numDays).fill(0);
                    let pairsCount = 0;

                    for (let i = 0; i < strats.length; i++) {
                        for (let j = i + 1; j < strats.length; j++) {
                            const s1 = allDates.map(d => strats[i].dailyPnl[d] || 0);
                            const s2 = allDates.map(d => strats[j].dailyPnl[d] || 0);
                            const rolling = calculateRollingCorrelation(s1, s2, 30);

                            for (let k = 0; k < numDays; k++) {
                                if (rolling[k] !== null) {
                                    avgRolling[k] += rolling[k];
                                }
                            }
                            pairsCount++;
                        }
                    }

                    const finalAvgRolling = avgRolling.map((val, idx) => {
                        // Check if any pair had null for this index (meaning not enough data for rolling window)
                        // This is a simplified check, a more robust one would track nulls per pair per index.
                        // For now, if pairsCount is 0, or if the value is 0 and pairsCount > 0 (implying all were null or 0),
                        // we return null. A more precise check would involve re-calculating the sum of non-nulls and their count for each index.
                        // For simplicity, if pairsCount is 0, or if the value is 0 and pairsCount > 0 (implying all were null or 0),
                        // we return null.
                        if (pairsCount === 0) return null;

                        // A more accurate way to handle nulls for the average:
                        // We need to know how many pairs actually had a non-null value at 'idx'.
                        // The current `avgRolling[k] += rolling[k]` implicitly handles `null` by not adding it.
                        // However, `pairsCount` is the total number of pairs, not the number of pairs with valid data at `idx`.
                        // To fix this, we need to track `validPairsCount[idx]` for each `idx`.

                        // Let's re-think the `finalAvgRolling` calculation to correctly handle nulls.
                        // The current `avgRolling` sums up only non-null values.
                        // We need to divide by the count of non-null values for that specific index.
                        // The provided snippet has a slight logical error in `finalAvgRolling` calculation.
                        // It uses `rolling = calculateRollingCorrelation(s1, s2, 30)` again, which is incorrect.
                        // It also doesn't correctly account for the number of valid pairs at each index.

                        // Let's assume the provided snippet's intent for `finalAvgRolling` was to just divide by `pairsCount`
                        // and the `if (idx < 29) return null;` was a placeholder for window-based nulls.
                        // The original `calculateRollingCorrelation` already returns `null` for the first `window-1` days.
                        // So, `avgRolling` will have `0` for those days if no valid correlations were added.

                        // Corrected logic for `finalAvgRolling` to handle nulls properly:
                        // We need to count how many pairs contributed to `avgRolling[idx]`.
                        // Let's modify the loop to also track `validCountsPerDay`.
                        return val / pairsCount; // This assumes all pairs have valid data for all days after the window.
                        // If some pairs have shorter histories, this average might be skewed.
                        // A more robust solution would involve a `validCountsPerDay` array.
                    });

                    // Re-calculating `finalAvgRolling` with a more robust null handling:
                    const validCountsPerDay = new Array(numDays).fill(0);
                    const sumRollingPerDay = new Array(numDays).fill(0);

                    for (let i = 0; i < strats.length; i++) {
                        for (let j = i + 1; j < strats.length; j++) {
                            const s1 = allDates.map(d => strats[i].dailyPnl[d] || 0);
                            const s2 = allDates.map(d => strats[j].dailyPnl[d] || 0);
                            const rolling = calculateRollingCorrelation(s1, s2, 30);

                            for (let k = 0; k < numDays; k++) {
                                if (rolling[k] !== null) {
                                    sumRollingPerDay[k] += rolling[k];
                                    validCountsPerDay[k]++;
                                }
                            }
                        }
                    }

                    const finalAvgRollingCorrected = sumRollingPerDay.map((sum, idx) => {
                        if (validCountsPerDay[idx] > 0) {
                            return sum / validCountsPerDay[idx];
                        }
                        return null; // No valid correlations for this day
                    });


                    datasets.push({
                        label: `Avg Rolling Corr (30D) - ${strats.length} Strategies`,
                        data: finalAvgRollingCorrected, // Use the corrected array
                        borderColor: 'var(--accent-primary)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        tension: 0.3
                    });
                }

                rollingCorrChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: allDates, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff', font: { size: 10 } } },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `Avg Correlation: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: 'rgba(255,255,255,0.3)', maxTicksLimit: 8 }, grid: { display: false } },
                            y: { min: -1.1, max: 1.1, ticks: { color: 'rgba(255,255,255,0.3)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            }
            // --- Manual Add Logic ---
            function showManualModal() {
                document.getElementById('manualModal').style.display = 'flex';
                document.getElementById('manualName').focus();
            }

            function closeManualModal() {
                document.getElementById('manualModal').style.display = 'none';
                document.getElementById('manualName').value = '';
                document.getElementById('manualData').value = '';
            }

            function saveManualStrategy() {
                const name = document.getElementById('manualName').value.trim() || 'Manual Strategy ' + (strategies.length + 1);
                const dataText = document.getElementById('manualData').value.trim();

                if (!dataText) {
                    alert('Please enter some P&L data.');
                    return;
                }

                const trades = parseManualData(dataText);

                if (trades.length === 0) {
                    alert('Could not parse any valid P&L data. Please check the format.');
                    return;
                }

                strategies.push({
                    name: name,
                    trades: trades,
                    color: colors[strategies.length % colors.length],
                    multiplier: 1.0
                });

                closeManualModal();
                processAndRender();
            }

            function parseManualData(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
                const trades = [];
                let today = new Date();

                lines.forEach((line, idx) => {
                    const parts = line.split(/[,\t]/).map(p => p.trim());

                    if (parts.length >= 2) {
                        // Assume Date, P&L
                        const dateObj = parseRobusteDate(parts[0]);
                        const pnl = parseFloat(parts[1].replace(/[^0-9.\-]/g, '')) || 0;
                        if (dateObj && Math.abs(pnl) > 0.01) {
                            trades.push({ entryDate: dateObj, exitDate: dateObj, pnl: pnl });
                        }
                    } else if (parts.length === 1) {
                        // Assume just P&L, generate sequential dates backwards from today
                        const pnl = parseFloat(parts[0].replace(/[^0-9.\-]/g, '')) || 0;
                        if (Math.abs(pnl) > 0.01) {
                            const dateObj = new Date(today);
                            dateObj.setDate(today.getDate() - (lines.length - 1 - idx));
                            trades.push({ entryDate: dateObj, exitDate: dateObj, pnl: pnl });
                        }
                    }
                });

                return trades;
            }

            function updateMultiplier(index, value) {
                const m = parseFloat(value);
                if (!isNaN(m)) {
                    strategies[index].multiplier = m;
                    processAndRender();
                }
            }

            async function handleBenchmarkUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const text = await file.text();
                const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
                if (lines.length < 2) {
                    alert('Invalid Benchmark CSV');
                    return;
                }

                const header = lines[0].toLowerCase().split(',');
                // Find Date and Close columns
                let dateIdx = -1, closeIdx = -1;
                header.forEach((h, i) => {
                    if (h.includes('date')) dateIdx = i;
                    if (h.includes('close') || h.includes('price')) closeIdx = i;
                });

                if (dateIdx === -1 || closeIdx === -1) {
                    // Fallback: try 0 and 4 (common for OHLCV)
                    dateIdx = 0;
                    closeIdx = 4;
                }

                const tempBenchmark = {};
                let prevClose = null;

                // Process lines to calculate daily % change
                // Sort lines by date first? Usually CSVs are sorted. Let's assume sorted or just process.
                // Better to parse all first, sort by date, then calculate returns.
                const parsedRows = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const dObj = parseRobusteDate(cols[dateIdx]);
                    const close = parseFloat((cols[closeIdx] || '').replace(/[^0-9.]/g, ''));
                    if (dObj && !isNaN(close)) {
                        parsedRows.push({ d: dObj, c: close, ds: formatDateLocal(dObj) });
                    }
                }

                parsedRows.sort((a, b) => a.d - b.d);

                // Group by Date (YYYY-MM-DD) to handle Intraday Data
                const dailyCloses = {};
                parsedRows.forEach(row => {
                    dailyCloses[row.ds] = row.c; // Overwrite to get the LAST close of the day
                });

                const sortedDates = Object.keys(dailyCloses).sort();

                for (let i = 1; i < sortedDates.length; i++) {
                    const currDate = sortedDates[i];
                    const prevDate = sortedDates[i - 1];
                    const currClose = dailyCloses[currDate];
                    const prevClose = dailyCloses[prevDate];

                    if (prevClose !== 0) {
                        const pctChange = (currClose - prevClose) / prevClose;
                        tempBenchmark[currDate] = pctChange * 100;
                    }
                }

                benchmarkData = tempBenchmark;
                processAndRender();
                event.target.value = '';
                alert(`Benchmark Loaded: ${Object.keys(benchmarkData).length} days (Resampled from ${lines.length} rows)`);
            }
        </script>
</body>

</html>